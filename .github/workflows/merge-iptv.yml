name: è‡ªåŠ¨åˆå¹¶IPTVåˆ—è¡¨ï¼ˆæ¯8åˆ†é’ŸÂ·ä¼˜åŒ–ç‰ˆï¼‰

on:
  schedule:
    # æ¯8åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '*/8 * * * *'
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/merge-iptv.yml'

jobs:
  merge-iptv:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # é˜²æ­¢ä»»åŠ¡æ— é™æŒ‚èµ·
    
    steps:
      - name: 1. åˆå§‹åŒ–ç¯å¢ƒ
        run: |
          echo "ğŸ”„ å·¥ä½œæµå¼€å§‹æ‰§è¡Œï¼š$(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ“± è¿è¡Œå™¨ä¿¡æ¯ï¼š$(uname -a)"
          echo "ğŸ“¦ ä»“åº“ï¼š${{ github.repository }}"
          
      - name: 2. æ£€å‡ºä»“åº“ä»£ç ï¼ˆå¸¦æ·±åº¦æ¸…ç†ï¼‰
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1  # åªè·å–æœ€æ–°æäº¤ï¼Œæé«˜é€Ÿåº¦
          clean: true     # æ¸…ç†å·¥ä½œåŒº
          
      - name: 3. æ™ºèƒ½ä¸‹è½½æºæ–‡ä»¶ï¼ˆå¸¦å®Œæ•´é”™è¯¯å¤„ç†ï¼‰
        id: download
        run: |
          set -e  # ä»»ä½•å‘½ä»¤å¤±è´¥åˆ™ç«‹å³åœæ­¢
          
          # å‡½æ•°ï¼šå®‰å…¨ä¸‹è½½æ–‡ä»¶
          safe_download() {
            local url=$1
            local output=$2
            local name=$3
            
            echo "ğŸ“¥ å¼€å§‹ä¸‹è½½ $name..."
            
            # å°è¯•ä¸‹è½½ï¼Œæ•è·æ›´å¤šä¿¡æ¯
            HTTP_STATUS=$(curl -s -L -w "%{http_code}" \
              --max-time 45 \
              --retry 3 \
              --retry-delay 2 \
              --retry-max-time 120 \
              -o "$output.tmp" \
              "$url" 2>&1 | tail -n1)
            
            if [ "$HTTP_STATUS" -eq 200 ]; then
              # éªŒè¯æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆï¼ˆéç©ºä¸”åŒ…å«M3Uç‰¹å¾ï¼‰
              if [ -s "$output.tmp" ] && (head -1 "$output.tmp" | grep -q "^#EXTM3U\|^#EXTINF" || tail -n +2 "$output.tmp" | grep -q "^#EXTINF"); then
                mv "$output.tmp" "$output"
                LINES=$(wc -l < "$output" | tr -d ' ')
                echo "âœ… $name ä¸‹è½½æˆåŠŸ ($LINES è¡Œ, HTTP $HTTP_STATUS)"
                echo "$name"_count=$(grep -c "^#EXTINF" "$output" || echo "0") >> $GITHUB_OUTPUT
                return 0
              else
                echo "âš ï¸ $name æ–‡ä»¶å†…å®¹æ— æ•ˆæˆ–æ ¼å¼é”™è¯¯"
                rm -f "$output.tmp"
                return 1
              fi
            else
              echo "âŒ $name ä¸‹è½½å¤±è´¥ (HTTP $HTTP_STATUS)"
              rm -f "$output.tmp"
              return 1
            fi
          }
          
          # å¹¶è¡Œä¸‹è½½ä¸¤ä¸ªæ–‡ä»¶
          if safe_download "https://raw.githubusercontent.com/mytv-android/BRTV-Live-M3U8/refs/heads/main/iptv.m3u" "source1.m3u" "IPTVåˆ—è¡¨"; then
            SOURCE1_VALID=true
          else
            SOURCE1_VALID=false
            # åˆ›å»ºç©ºæ–‡ä»¶å ä½
            echo "# æºæ–‡ä»¶ä¸´æ—¶ä¸å¯ç”¨ - $(date '+%H:%M:%S')" > source1.m3u
          fi
          
          if safe_download "https://raw.githubusercontent.com/liniani/BRTV-Live-M3U8/refs/heads/main/cctv.m3u" "source2.m3u" "CCTVåˆ—è¡¨"; then
            SOURCE2_VALID=true
          else
            SOURCE2_VALID=false
            echo "# æºæ–‡ä»¶ä¸´æ—¶ä¸å¯ç”¨ - $(date '+%H:%M:%S')" > source2.m3u
          fi
          
          # è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "source1_valid=$SOURCE1_VALID" >> $GITHUB_OUTPUT
          echo "source2_valid=$SOURCE2_VALID" >> $GITHUB_OUTPUT
          
      - name: 4. å®‰å…¨åˆå¹¶æ–‡ä»¶
        id: merge
        run: |
          set -e
          
          CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          NEXT_RUN=$(date -d '+8 minutes' '+%H:%M:%S')
          
          # ç»Ÿè®¡ä¿¡æ¯
          SOURCE1_COUNT=$(grep -c "^#EXTINF" source1.m3u 2>/dev/null || echo "0")
          SOURCE2_COUNT=$(grep -c "^#EXTINF" source2.m3u 2>/dev/null || echo "0")
          TOTAL=$((SOURCE1_COUNT + SOURCE2_COUNT))
          
          # åˆ›å»ºä¸´æ—¶åˆå¹¶æ–‡ä»¶
          TEMP_FILE="2026IPTV_temp_$(date +%s).m3u"
          
          {
            echo "#EXTM3U x-tvg-url=\"\""
            echo "# Generated by Auto-Merger"
            echo "# Merge Time: $CURRENT_TIME"
            echo "# Next Update: $NEXT_RUN (æ¯8åˆ†é’Ÿ)"
            echo "# Sources:"
            echo "#   1. mytv-android/BRTV-Live-M3U8 (IPTV) - $SOURCE1_COUNT channels"
            echo "#   2. liniani/BRTV-Live-M3U8 (CCTV) - $SOURCE2_COUNT channels"
            echo ""
            
            # å¤„ç†ç¬¬ä¸€ä¸ªæ–‡ä»¶
            echo "# ğŸ“º IPTV ç›´æ’­é¢‘é“ ($SOURCE1_COUNT)"
            if [ "${{ steps.download.outputs.source1_valid }}" = "true" ] && [ "$SOURCE1_COUNT" -gt 0 ]; then
              # è·³è¿‡M3Uå¤´ï¼Œä¿ç•™å…¶ä»–æ‰€æœ‰å†…å®¹
              grep -v "^#EXTM3U" source1.m3u || cat source1.m3u
            else
              echo "#EXTINF:-1,é¢‘é“åˆ—è¡¨æš‚ä¸å¯ç”¨"
              echo "# è¯·ç­‰å¾…ä¸‹æ¬¡è‡ªåŠ¨æ›´æ–°"
            fi
            
            echo ""
            echo "# ğŸ  ä¸­å¤®ç”µè§†å°é¢‘é“ ($SOURCE2_COUNT)"
            if [ "${{ steps.download.outputs.source2_valid }}" = "true" ] && [ "$SOURCE2_COUNT" -gt 0 ]; then
              grep -v "^#EXTM3U" source2.m3u || cat source2.m3u
            else
              echo "#EXTINF:-1,é¢‘é“åˆ—è¡¨æš‚ä¸å¯ç”¨"
              echo "# è¯·ç­‰å¾…ä¸‹æ¬¡è‡ªåŠ¨æ›´æ–°"
            fi
            
            echo ""
            echo "# ğŸ“Š ç»Ÿè®¡ä¿¡æ¯"
            echo "# æ€»é¢‘é“æ•°: $TOTAL"
            echo "# IPTVé¢‘é“: $SOURCE1_COUNT"
            echo "# CCTVé¢‘é“: $SOURCE2_COUNT"
            echo "# ç”Ÿæˆæ—¶é—´æˆ³: $(date +%s)"
            echo "# æ ¡éªŒå’Œ: $(md5sum <<< "$CURRENT_TIME" | cut -d' ' -f1)"
          } > "$TEMP_FILE"
          
          # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†æœ‰æ•ˆå†…å®¹
          if [ -s "$TEMP_FILE" ] && [ "$TOTAL" -gt 0 ]; then
            # æ›¿æ¢æ—§æ–‡ä»¶
            mv -f "$TEMP_FILE" "2026IPTV.m3u"
            echo "âœ… åˆå¹¶æ–‡ä»¶åˆ›å»ºæˆåŠŸ"
            echo "total_channels=$TOTAL" >> $GITHUB_OUTPUT
            echo "merge_success=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ åˆå¹¶æ–‡ä»¶å†…å®¹ä¸ºç©ºï¼Œä¿ç•™æ—§ç‰ˆæœ¬"
            echo "merge_success=false" >> $GITHUB_OUTPUT
            # å¦‚æœæœ‰æ—§æ–‡ä»¶ï¼Œä¿ç•™å®ƒ
            if [ -f "2026IPTV.m3u" ]; then
              echo "ğŸ“ ä½¿ç”¨å·²æœ‰çš„ 2026IPTV.m3u æ–‡ä»¶"
            fi
          fi
          
      - name: 5. æ™ºèƒ½Gitæ¨é€ï¼ˆé¿å…å†²çªï¼‰
        if: steps.merge.outputs.merge_success == 'true'
        run: |
          set -e
          
          echo "ğŸ”§ é…ç½®Gitç¯å¢ƒ..."
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions@github.com'
          
          # ç¡®ä¿æ˜¯æœ€æ–°ç‰ˆæœ¬
          echo "ğŸ“¡ æ‹‰å–æœ€æ–°ä»“åº“çŠ¶æ€..."
          git pull origin main --rebase --autostash || true
          
          # æ·»åŠ æ–‡ä»¶
          git add -f 2026IPTV.m3u
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…æ›´æ”¹
          if git diff --cached --quiet; then
            echo "ğŸ“„ æ–‡ä»¶å†…å®¹æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            echo "ğŸ’¾ å‡†å¤‡æäº¤æ›´æ”¹..."
            
            # ç”Ÿæˆæœ‰æ„ä¹‰çš„æäº¤ä¿¡æ¯
            COMMIT_TIME=$(date '+%Y-%m-%d %H:%M')
            CHANNEL_COUNT="${{ steps.merge.outputs.total_channels }}"
            
            git commit -m "ğŸ”„ IPTVåˆ—è¡¨æ›´æ–° $COMMIT_TIME" \
                       -m "é¢‘é“æ€»æ•°: $CHANNEL_COUNT | è‡ªåŠ¨æ›´æ–°" \
                       --allow-empty
            
            # å®‰å…¨æ¨é€ï¼ˆæœ€å¤šé‡è¯•3æ¬¡ï¼‰
            for i in {1..3}; do
              echo "ğŸš€ å°è¯•æ¨é€ (#$i)..."
              if git push origin main; then
                echo "âœ… æ¨é€æˆåŠŸ"
                break
              else
                echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
                sleep 10
                git pull origin main --rebase
              fi
            done
          fi
          
      - name: 6. éªŒè¯ä¸æ¸…ç†
        run: |
          echo "ğŸ“‹ æœ€ç»ˆéªŒè¯æ£€æŸ¥"
          echo "========================"
          
          if [ -f "2026IPTV.m3u" ]; then
            FILE_SIZE=$(wc -l < "2026IPTV.m3u")
            FILE_AGE=$(($(date +%s) - $(stat -c %Y "2026IPTV.m3u" 2>/dev/null || echo 0)))
            
            echo "ğŸ“ æ–‡ä»¶å: 2026IPTV.m3u"
            echo "ğŸ“ æ–‡ä»¶è¡Œæ•°: $FILE_SIZE"
            echo "â±ï¸  æ–‡ä»¶å¹´é¾„: ${FILE_AGE}ç§’"
            echo ""
            echo "ğŸ“„ æ–‡ä»¶å¤´éƒ¨é¢„è§ˆ:"
            head -8 "2026IPTV.m3u"
            echo ""
            echo "ğŸ“„ æ–‡ä»¶å°¾éƒ¨é¢„è§ˆ:"
            tail -5 "2026IPTV.m3u"
            echo ""
            
            # è®¡ç®—é¢‘é“æ•°
            CHANNELS=$(grep -c "^#EXTINF" "2026IPTV.m3u" 2>/dev/null || echo "0")
            echo "ğŸ“º å®é™…é¢‘é“æ•°é‡: $CHANNELS"
            
          else
            echo "âŒ é”™è¯¯ï¼šæœ€ç»ˆæ–‡ä»¶æœªç”Ÿæˆ"
          fi
          
          echo ""
          echo "ğŸ”— è®¿é—®é“¾æ¥:"
          echo "åŸå§‹é“¾æ¥: https://raw.githubusercontent.com/${{ github.repository }}/main/2026IPTV.m3u"
          echo "é˜²ç¼“å­˜é“¾æ¥: https://raw.githubusercontent.com/${{ github.repository }}/main/2026IPTV.m3u?v=$(date +%s)"
          
          echo ""
          echo "â° ä¸‹æ¬¡è¿è¡Œæ—¶é—´:"
          echo "- UTC: $(date -d '+8 minutes' '+%H:%M:%S')"
          echo "- åŒ—äº¬æ—¶é—´: $(TZ=Asia/Shanghai date -d '+8 minutes' '+%H:%M:%S')"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f source1.m3u source2.m3u 2026IPTV_temp_*.m3u
          echo "ğŸ§¹ ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"
          
      - name: 7. å¤±è´¥é€šçŸ¥ï¼ˆä»…é”™è¯¯æ—¶è¿è¡Œï¼‰
        if: failure()
        run: |
          echo "âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥ï¼"
          echo ""
          echo "å¯èƒ½çš„åŸå› :"
          echo "1. ğŸ”Œ ç½‘ç»œè¿æ¥é—®é¢˜ - æºç«™æ— æ³•è®¿é—®"
          echo "2. ğŸ” æƒé™é—®é¢˜ - GitHub Tokenå¤±æ•ˆ"
          echo "3. ğŸ“„ æ–‡ä»¶æ ¼å¼é—®é¢˜ - æºæ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„M3Uæ ¼å¼"
          echo "4. â±ï¸  è¶…æ—¶é—®é¢˜ - ä¸‹è½½æˆ–å¤„ç†æ—¶é—´è¿‡é•¿"
          echo ""
          echo "ğŸ’¡ è§£å†³æ–¹æ¡ˆ:"
          echo "1. æ£€æŸ¥æºURLæ˜¯å¦å¯è®¿é—®"
          echo "2. æŸ¥çœ‹ä¸Šæ–¹çš„è¯¦ç»†é”™è¯¯æ—¥å¿—"
          echo "3. ç­‰å¾…ä¸‹ä¸€æ¬¡è‡ªåŠ¨é‡è¯•ï¼ˆ8åˆ†é’Ÿåï¼‰"
          echo "4. æ‰‹åŠ¨è¿è¡Œå·¥ä½œæµæµ‹è¯•"
