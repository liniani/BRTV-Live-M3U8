name: ğŸ• è‡ªåŠ¨åˆå¹¶IPTV (æ¯8åˆ†é’Ÿ)
on:
  # ğŸ”„ æ ¸å¿ƒè§¦å‘å™¨ï¼šæ¯8åˆ†é’Ÿè‡ªåŠ¨è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
  schedule:
    - cron: '*/8 * * * *'
  # ğŸš€ æ‰‹åŠ¨è§¦å‘æŒ‰é’®ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  workflow_dispatch:
  # ğŸ”§ å½“æ­¤å·¥ä½œæµæ–‡ä»¶æœ¬èº«è¢«æ›´æ–°æ—¶ä¹Ÿè¿è¡Œ
  push:
    paths:
      - '.github/workflows/merge-iptv.yml'

# âš™ï¸ æˆäºˆGITHUB_TOKENè¶³å¤Ÿçš„æƒé™æ¥æ¨é€ä»£ç 
permissions:
  contents: write

jobs:
  merge-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 10 # é˜²æ­¢ä»»åŠ¡å¡æ­»

    steps:
      # æ­¥éª¤1: å‡†å¤‡ç¯å¢ƒå¹¶æ‰“å°ä¿¡æ¯
      - name: ğŸ“¦ åˆå§‹åŒ–ä¸ä¿¡æ¯
        run: |
          echo "âœ… å·¥ä½œæµå·²è§¦å‘!"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "å½“å‰æ—¶é—´ (UTC): $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "å½“å‰æ—¶é—´ (åŒ—äº¬æ—¶é—´): $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          echo "ä¸‹æ¬¡è®¡åˆ’è¿è¡Œ (UTC): æ¯å°æ—¶çš„ 0, 8, 16, 24, 32, 40, 48, 56 åˆ†é’Ÿ"
          
      # æ­¥éª¤2: æ‹‰å–ä»“åº“ä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # ä¸ºå‡å°‘å†²çªï¼Œå…ˆæ‹‰å–æœ€æ–°ä»£ç 
          fetch-depth: 0

      # æ­¥éª¤3: ä¸‹è½½æºæ–‡ä»¶ (å¸¦é‡è¯•å’ŒéªŒè¯)
      - name: ğŸŒ ä¸‹è½½IPTVæºæ–‡ä»¶
        id: download
        run: |
          set -e # é‡åˆ°é”™è¯¯å³åœæ­¢
          echo "å¼€å§‹ä¸‹è½½æºæ–‡ä»¶..."
          
          # å®šä¹‰ä¸‹è½½å‡½æ•°
          download_file() {
            local url=$1
            local filename=$2
            local max_retries=3
            local retry_count=0
            
            while [ $retry_count -lt $max_retries ]; do
              echo "å°è¯•ä¸‹è½½ $filename (ç¬¬ $((retry_count+1)) æ¬¡)..."
              # ä½¿ç”¨curlä¸‹è½½ï¼Œè·å–HTTPçŠ¶æ€ç 
              http_code=$(curl -s -L -w "%{http_code}" -o "$filename.tmp" "$url")
              
              if [ "$http_code" -eq 200 ]; then
                # åŸºæœ¬éªŒè¯ï¼šæ–‡ä»¶éç©ºä¸”æ˜¯æ–‡æœ¬
                if [ -s "$filename.tmp" ] && file "$filename.tmp" | grep -q "text"; then
                  mv "$filename.tmp" "$filename"
                  lines=$(wc -l < "$filename")
                  echo "  æˆåŠŸ: $filename ($lines è¡Œ)"
                  return 0
                else
                  echo "  è­¦å‘Š: æ–‡ä»¶å†…å®¹æ— æ•ˆï¼Œå°†é‡è¯•..."
                fi
              else
                echo "  å¤±è´¥: HTTP $http_code"
              fi
              
              retry_count=$((retry_count+1))
              sleep 2
            done
            echo "âŒ é”™è¯¯: ä¸‹è½½ $filename å¤±è´¥ï¼Œè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
            # åˆ›å»ºç©ºæ–‡ä»¶å ä½ï¼Œé¿å…åç»­å‘½ä»¤ä¸­æ–­
            echo "# æºæ–‡ä»¶æš‚æ—¶ä¸å¯ç”¨ [$(date +%H:%M:%S)]" > "$filename"
            return 1
          }
          
          # å¹¶è¡Œä¸‹è½½ä¸¤ä¸ªæ–‡ä»¶
          download_file "https://raw.githubusercontent.com/mytv-android/BRTV-Live-M3U8/refs/heads/main/iptv.m3u" "source_iptv.m3u" &
          download_file "https://raw.githubusercontent.com/liniani/BRTV-Live-M3U8/refs/heads/main/cctv.m3u" "source_cctv.m3u" &
          
          # ç­‰å¾…æ‰€æœ‰åå°ä¸‹è½½ä»»åŠ¡å®Œæˆ
          wait
          
          echo "æ‰€æœ‰ä¸‹è½½ä»»åŠ¡å®Œæˆã€‚"
          # ç»Ÿè®¡ä¿¡æ¯
          count_iptv=$(grep -c "^#EXTINF" source_iptv.m3u 2>/dev/null || echo "0")
          count_cctv=$(grep -c "^#EXTINF" source_cctv.m3u 2>/dev/null || echo "0")
          echo "é¢‘é“ç»Ÿè®¡: IPTV=$count_iptv, CCTV=$count_cctv"
          
          # è®¾ç½®è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "count_iptv=$count_iptv" >> $GITHUB_OUTPUT
          echo "count_cctv=$count_cctv" >> $GITHUB_OUTPUT

      # æ­¥éª¤4: åˆå¹¶æ–‡ä»¶
      - name: ğŸ§© åˆå¹¶M3Uæ–‡ä»¶
        id: merge
        run: |
          echo "å¼€å§‹åˆå¹¶æ–‡ä»¶..."
          current_time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          next_run=$(TZ='Asia/Shanghai' date -d '+8 minutes' '+%H:%M:%S')
          
          # è¯»å–é¢‘é“æ•°é‡
          count_iptv="${{ steps.download.outputs.count_iptv }}"
          count_cctv="${{ steps.download.outputs.count_cctv }}"
          total_channels=$((count_iptv + count_cctv))
          
          # åˆ›å»ºæ–°çš„åˆå¹¶æ–‡ä»¶
          {
            echo "#EXTM3U"
            echo "# åç§°: 2026IPTV è‡ªåŠ¨åˆå¹¶åˆ—è¡¨"
            echo "# ç”Ÿæˆæ—¶é—´: $current_time (åŒ—äº¬æ—¶é—´)"
            echo "# ä¸‹æ¬¡æ›´æ–°: $next_run (æ¯8åˆ†é’Ÿ)"
            echo "# æ¥æº1: mytv-android/BRTV-Live-M3U8 (IPTVé¢‘é“: $count_iptv ä¸ª)"
            echo "# æ¥æº2: liniani/BRTV-Live-M3U8 (CCTVé¢‘é“: $count_cctv ä¸ª)"
            echo "# æ€»é¢‘é“æ•°: $total_channels"
            echo ""
            echo "# ğŸŸ¢ ==================== IPTV é¢‘é“ ===================="
            # æ·»åŠ ç¬¬ä¸€ä¸ªæºçš„å†…å®¹ï¼ˆè·³è¿‡å¯èƒ½çš„æ–‡ä»¶å¤´ï¼‰
            tail -n +2 source_iptv.m3u 2>/dev/null || cat source_iptv.m3u
            echo ""
            echo "# ğŸ”´ ==================== CCTV é¢‘é“ ===================="
            # æ·»åŠ ç¬¬äºŒä¸ªæºçš„å†…å®¹
            tail -n +2 source_cctv.m3u 2>/dev/null || cat source_cctv.m3u
            echo ""
            echo "# â„¹ï¸ æ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆäº $current_time"
            echo "# ç”± GitHub Actions ç»´æŠ¤ï¼Œæ¯8åˆ†é’Ÿæ›´æ–°"
          } > 2026IPTV.m3u
          
          # éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
          if [ -s "2026IPTV.m3u" ]; then
            final_lines=$(wc -l < "2026IPTV.m3u")
            echo "âœ… åˆå¹¶æˆåŠŸï¼ç”Ÿæˆæ–‡ä»¶ 2026IPTV.m3u"
            echo "   æ–‡ä»¶æ€»è¡Œæ•°: $final_lines"
            echo "   åŒ…å«é¢‘é“æ•°: $total_channels"
            echo "merge_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ åˆå¹¶å¤±è´¥ï¼Œç”Ÿæˆçš„æ–‡ä»¶ä¸ºç©ºï¼"
            echo "merge_success=false" >> $GITHUB_OUTPUT
          fi

      # æ­¥éª¤5: æ¨é€æ›´æ–°åˆ°ä»“åº“
      - name: ğŸ“¤ æ¨é€æ›´æ–°
        if: steps.merge.outputs.merge_success == 'true'
        run: |
          echo "å‡†å¤‡æ¨é€æ›´æ–°åˆ°ä»“åº“..."
          
          # é…ç½®Gitèº«ä»½
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # ç¡®ä¿æˆ‘ä»¬åœ¨ä¸»åˆ†æ”¯ï¼Œä¸”æ˜¯æœ€æ–°çŠ¶æ€
          git checkout main
          git pull --rebase origin main
          
          # æ·»åŠ ã€æäº¤å¹¶æ¨é€æ›´æ”¹
          git add 2026IPTV.m3u
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…æ›´æ”¹
          if git diff --cached --quiet; then
            echo "âš ï¸ æ£€æµ‹ç»“æœ: æ–‡ä»¶å†…å®¹æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            commit_time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°IPTVåˆ—è¡¨ [$commit_time]" \
                       -m "é¢‘é“æ•°: ${{ steps.download.outputs.count_iptv }} IPTV + ${{ steps.download.outputs.count_cctv }} CCTV" \
                       --allow-empty
            
            echo "æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“..."
            # ä½¿ç”¨--force-with-leaseæ›´å®‰å…¨åœ°å¼ºåˆ¶æ¨é€
            git push --force-with-lease origin main
            echo "âœ… æ¨é€æˆåŠŸï¼"
          fi

      # æ­¥éª¤6: æœ€ç»ˆçŠ¶æ€æŠ¥å‘Š
      - name: ğŸ“Š æœ€ç»ˆæŠ¥å‘Š
        if: always()
        run: |
          echo "====================== å·¥ä½œæµæ‰§è¡ŒæŠ¥å‘Š ======================"
          echo "ä»»åŠ¡çŠ¶æ€: ${{ job.status }}"
          echo "åˆå¹¶ç»“æœ: ${{ steps.merge.outputs.merge_success || 'æœªæ‰§è¡Œ' }}"
          echo "å½“å‰æ—¶é—´: $(TZ='Asia/Shanghai' date '+%H:%M:%S')"
          
          if [ -f "2026IPTV.m3u" ]; then
            echo "ç”Ÿæˆæ–‡ä»¶: 2026IPTV.m3u"
            echo "æ–‡ä»¶å¤§å°: $(wc -l < 2026IPTV.m3u) è¡Œ"
            echo ""
            echo "ğŸ”— é‡è¦é“¾æ¥:"
            echo "ç›´æ¥è®¿é—®: https://raw.githubusercontent.com/${{ github.repository }}/main/2026IPTV.m3u"
            echo "é˜²ç¼“å­˜è®¿é—®: https://raw.githubusercontent.com/${{ github.repository }}/main/2026IPTV.m3u?t=$(date +%s)"
          else
            echo "âŒ è­¦å‘Š: æœ€ç»ˆæ–‡ä»¶æœªç”Ÿæˆï¼"
          fi
          
          echo ""
          echo "â° é¢„è®¡ä¸‹æ¬¡è‡ªåŠ¨è¿è¡Œ:"
          echo "   UTCæ—¶é—´: $(date -u -d '+8 minutes' '+%H:%M:%S')"
          echo "   åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date -d '+8 minutes' '+%H:%M:%S')"
          echo "=========================================================="
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f source_iptv.m3u source_cctv.m3u
