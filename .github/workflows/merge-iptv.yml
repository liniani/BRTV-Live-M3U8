name: ğŸ•™ IPTVåˆ—è¡¨è‡ªåŠ¨åˆå¹¶ (æ¯10åˆ†é’Ÿ)

on:
  # ä¸»è§¦å‘å™¨ï¼šæ¯10åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '*/10 * * * *'  # æ¯å°æ—¶çš„ 0,10,20,30,40,50 åˆ†é’Ÿè¿è¡Œ
  # å¤‡ç”¨è§¦å‘å™¨ï¼šæ”¯æŒæ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ
  workflow_dispatch:
  # ç›‘æ§è§¦å‘å™¨ï¼šå½“å·¥ä½œæµæ–‡ä»¶è‡ªèº«å˜æ›´æ—¶ä¹Ÿè¿è¡Œ
  push:
    paths:
      - '.github/workflows/merge_iptv.yml'

# èµ‹äºˆå·¥ä½œæµå†™å…¥ä»“åº“çš„æƒé™ï¼ˆå…³é”®æ­¥éª¤ï¼‰
permissions:
  contents: write

jobs:
  merge-iptv-job:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1ï¼šæ£€æŸ¥ä»£ç å¹¶æ˜¾ç¤ºä¿¡æ¯
      - name: ğŸ“¡ æ£€å‡ºä»£ç  & çŠ¶æ€æŠ¥å‘Š
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
        env:
          TZ: Asia/Shanghai

      - name: â„¹ï¸ æ˜¾ç¤ºæ‰§è¡Œä¿¡æ¯
        run: |
          echo "=== ä»»åŠ¡å¯åŠ¨ ==="
          echo "è§¦å‘æ–¹å¼ï¼š${{ github.event_name }}"
          echo "æ‰§è¡Œæ—¶é—´ï¼ˆUTCï¼‰ï¼š$(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "æ‰§è¡Œæ—¶é—´ï¼ˆåŒ—äº¬ï¼‰ï¼š$(date '+%Y-%m-%d %H:%M:%S')"
          echo "ä»“åº“åˆ†æ”¯ï¼š${{ github.ref }}"
          echo "================="

      # æ­¥éª¤2ï¼šä¸‹è½½æºæ–‡ä»¶
      - name: ğŸŒ ä¸‹è½½IPTVæºåˆ—è¡¨
        run: |
          set -e  # é‡åˆ°é”™è¯¯åˆ™åœæ­¢
          echo "å¼€å§‹ä¸‹è½½æºæ–‡ä»¶..."
          
          # ä¸‹è½½ç¬¬ä¸€ä¸ªåˆ—è¡¨ (IPTV)
          if curl -s -f -L --max-time 30 --retry 2 -o iptv_source.m3u "https://raw.githubusercontent.com/mytv-android/BRTV-Live-M3U8/refs/heads/main/iptv.m3u"; then
            IPTV_LINES=$(wc -l < iptv_source.m3u)
            echo "âœ… ä¸‹è½½IPTVåˆ—è¡¨æˆåŠŸ ($IPTV_LINES è¡Œ)"
          else
            echo "âš ï¸ IPTVåˆ—è¡¨ä¸‹è½½å¤±è´¥ï¼Œåˆ›å»ºç©ºæ–‡ä»¶"
            echo "# IPTVæºæš‚æ—¶ä¸å¯ç”¨" > iptv_source.m3u
          fi
          
          # ä¸‹è½½ç¬¬äºŒä¸ªåˆ—è¡¨ (CCTV)
          if curl -s -f -L --max-time 30 --retry 2 -o cctv_source.m3u "https://raw.githubusercontent.com/liniani/BRTV-Live-M3U8/refs/heads/main/cctv.m3u"; then
            CCTV_LINES=$(wc -l < cctv_source.m3u)
            echo "âœ… ä¸‹è½½CCTVåˆ—è¡¨æˆåŠŸ ($CCTV_LINES è¡Œ)"
          else
            echo "âš ï¸ CCTVåˆ—è¡¨ä¸‹è½½å¤±è´¥ï¼Œåˆ›å»ºç©ºæ–‡ä»¶"
            echo "# CCTVæºæš‚æ—¶ä¸å¯ç”¨" > cctv_source.m3u
          fi

      # æ­¥éª¤3ï¼šåˆå¹¶æ–‡ä»¶
      - name: ğŸ§© åˆå¹¶ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶
        id: merge
        run: |
          echo "å¼€å§‹åˆå¹¶æ–‡ä»¶..."
          
          # è®¡ç®—é¢‘é“æ•°é‡
          IPTV_COUNT=$(grep -c '^#EXTINF' iptv_source.m3u 2>/dev/null || echo "0")
          CCTV_COUNT=$(grep -c '^#EXTINF' cctv_source.m3u 2>/dev/null || echo "0")
          TOTAL_COUNT=$((IPTV_COUNT + CCTV_COUNT))
          
          # ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å†…å®¹
          CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          NEXT_RUN=$(date -d '+10 minutes' '+%H:%M:%S')
          
          cat > 2026IPTV.m3u << EOF
#EXTM3U
# è‡ªåŠ¨åˆå¹¶IPTVåˆ—è¡¨
# ç”Ÿæˆæ—¶é—´: $CURRENT_TIME (åŒ—äº¬æ—¶é—´)
# ä¸‹æ¬¡æ›´æ–°: $NEXT_RUN (æ¯10åˆ†é’Ÿ)
# 
# æº1: IPTVåˆ—è¡¨ (å…± $IPTV_COUNT ä¸ªé¢‘é“)
# æº2: CCTVåˆ—è¡¨ (å…± $CCTV_COUNT ä¸ªé¢‘é“)
# æ€»è®¡: $TOTAL_COUNT ä¸ªé¢‘é“
# 
# ============ IPTVé¢‘é“ ============
EOF
          # æ·»åŠ IPTVå†…å®¹ï¼Œè·³è¿‡å¯èƒ½çš„#EXTM3Uå¤´
          grep -v '^#EXTM3U' iptv_source.m3u >> 2026IPTV.m3u 2>/dev/null || cat iptv_source.m3u >> 2026IPTV.m3u
          
          echo -e "\n# ============ CCTVé¢‘é“ ============" >> 2026IPTV.m3u
          # æ·»åŠ CCTVå†…å®¹
          grep -v '^#EXTM3U' cctv_source.m3u >> 2026IPTV.m3u 2>/dev/null || cat cctv_source.m3u >> 2026IPTV.m3u
          
          echo -e "\n# æ–‡ä»¶ç»“æŸ" >> 2026IPTV.m3u
          
          FINAL_LINES=$(wc -l < 2026IPTV.m3u)
          echo "âœ… åˆå¹¶å®Œæˆï¼"
          echo "ç”Ÿæˆæ–‡ä»¶: 2026IPTV.m3u ($FINAL_LINES è¡Œ)"
          echo "é¢‘é“ç»Ÿè®¡: IPTV=$IPTV_COUNT, CCTV=$CCTV_COUNT, æ€»è®¡=$TOTAL_COUNT"
          
          # è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "total_count=$TOTAL_COUNT" >> $GITHUB_OUTPUT
          echo "file_created=true" >> $GITHUB_OUTPUT

      # æ­¥éª¤4ï¼šæ¨é€æ›´æ–°
      - name: ğŸ“¤ æäº¤å¹¶æ¨é€æ›´æ–°
        if: steps.merge.outputs.file_created == 'true'
        run: |
          echo "å‡†å¤‡æäº¤æ›´æ”¹..."
          
          # é…ç½®Git
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # æ‹‰å–æœ€æ–°ä»£ç é¿å…å†²çª
          git pull origin main --rebase --autostash 2>/dev/null || true
          
          # æ·»åŠ æ–‡ä»¶å¹¶æäº¤
          git add 2026IPTV.m3u
          
          if git diff --cached --quiet; then
            echo "æ–‡ä»¶å†…å®¹æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            COMMIT_TIME=$(date '+%Y-%m-%d %H:%M')
            git commit -m "ğŸ“º è‡ªåŠ¨æ›´æ–°IPTVåˆ—è¡¨ [$COMMIT_TIME]" \
                       -m "æ€»è®¡ ${{ steps.merge.outputs.total_count }} ä¸ªé¢‘é“ | æ¯10åˆ†é’Ÿæ›´æ–°"
            
            echo "æ­£åœ¨æ¨é€..."
            git push origin main
            echo "âœ… æ¨é€æˆåŠŸï¼"
          fi

      # æ­¥éª¤5ï¼šæœ€ç»ˆæŠ¥å‘Š
      - name: ğŸ“Š ç”ŸæˆæŠ¥å‘Š
        if: always()
        run: |
          echo "=== æ‰§è¡ŒæŠ¥å‘Š ==="
          echo "ä»»åŠ¡çŠ¶æ€: ${{ job.status }}"
          echo "è§¦å‘åŸå› : ${{ github.event_name }}"
          echo "å®Œæˆæ—¶é—´: $(date '+%H:%M:%S')"
          
          if [ -f "2026IPTV.m3u" ]; then
            echo "ç”Ÿæˆæ–‡ä»¶: 2026IPTV.m3u"
            echo "æ–‡ä»¶å¤§å°: $(wc -l < 2026IPTV.m3u) è¡Œ"
            echo ""
            echo "ğŸ“ æ–‡ä»¶è®¿é—®åœ°å€:"
            echo "https://raw.githubusercontent.com/${{ github.repository }}/main/2026IPTV.m3u"
            echo "é˜²ç¼“å­˜åœ°å€:"
            echo "https://raw.githubusercontent.com/${{ github.repository }}/main/2026IPTV.m3u?t=$(date +%s)"
          else
            echo "âš ï¸ æœªç”Ÿæˆæœ€ç»ˆæ–‡ä»¶"
          fi
          
          echo ""
          echo "â° ä¸‹æ¬¡è®¡åˆ’è¿è¡Œ:"
          echo "UTCæ—¶é—´: $(date -u -d '+10 minutes' '+%H:%M:%S')"
          echo "åŒ—äº¬æ—¶é—´: $(date -d '+10 minutes' '+%H:%M:%S')"
          echo "================"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f iptv_source.m3u cctv_source.m3u
