name: è‡ªåŠ¨åˆå¹¶IPTVåˆ—è¡¨ï¼ˆæ¯8åˆ†é’Ÿï¼‰

on:
  schedule:
    # æ¯8åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '*/8 * * * *'
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/merge-iptv.yml'

jobs:
  merge-iptv:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: 2. ä¸‹è½½ä¸¤ä¸ªæºæ–‡ä»¶
        run: |
          echo "ğŸ• å¼€å§‹ä¸‹è½½æºæ–‡ä»¶ï¼š$(date '+%H:%M:%S')"
          
          # ä¸‹è½½ç¬¬ä¸€ä¸ªæºæ–‡ä»¶ï¼ˆIPTVåˆ—è¡¨ï¼‰
          curl -s -L --max-time 30 --retry 2 -o source1.m3u "https://raw.githubusercontent.com/mytv-android/BRTV-Live-M3U8/refs/heads/main/iptv.m3u"
          SOURCE1_SIZE=$(wc -l < source1.m3u | tr -d ' ')
          echo "âœ… IPTVåˆ—è¡¨ä¸‹è½½å®Œæˆï¼ˆ${SOURCE1_SIZE}è¡Œï¼‰"
          
          # ä¸‹è½½ç¬¬äºŒä¸ªæºæ–‡ä»¶ï¼ˆCCTVåˆ—è¡¨ï¼‰
          curl -s -L --max-time 30 --retry 2 -o source2.m3u "https://raw.githubusercontent.com/liniani/BRTV-Live-M3U8/refs/heads/main/cctv.m3u"
          SOURCE2_SIZE=$(wc -l < source2.m3u | tr -d ' ')
          echo "âœ… CCTVåˆ—è¡¨ä¸‹è½½å®Œæˆï¼ˆ${SOURCE2_SIZE}è¡Œï¼‰"
          
      - name: 3. åˆ›å»ºåˆå¹¶æ–‡ä»¶
        run: |
          CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          NEXT_RUN=$(date -d '+8 minutes' '+%H:%M')
          
          rm -f 2026IPTV.m3u
          
          echo "#EXTM3U" > 2026IPTV.m3u
          echo "# Generated by Auto-Merger at $CURRENT_TIME" >> 2026IPTV.m3u
          echo "# Next auto-update: $NEXT_RUN" >> 2026IPTV.m3u
          echo "# Source 1: mytv-android/BRTV-Live-M3U8 (IPTV)" >> 2026IPTV.m3u
          echo "# Source 2: liniani/BRTV-Live-M3U8 (CCTV)" >> 2026IPTV.m3u
          echo "" >> 2026IPTV.m3u
          
          # å¤„ç†ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼ˆIPTVï¼‰
          echo "# ğŸ“º IPTVé¢‘é“" >> 2026IPTV.m3u
          if [ -s source1.m3u ]; then
            if grep -q "^#EXTM3U" source1.m3u; then
              tail -n +2 source1.m3u >> 2026IPTV.m3u
            else
              cat source1.m3u >> 2026IPTV.m3u
            fi
            SOURCE1_COUNT=$(grep -c "^#EXTINF" source1.m3u || echo "0")
          else
            echo "# æ³¨æ„ï¼šIPTVæºæ–‡ä»¶ä¸ºç©ºæˆ–ä¸‹è½½å¤±è´¥" >> 2026IPTV.m3u
            SOURCE1_COUNT=0
          fi
          
          echo "" >> 2026IPTV.m3u
          echo "# ğŸ  ä¸­å¤®ç”µè§†å°é¢‘é“" >> 2026IPTV.m3u
          
          # å¤„ç†ç¬¬äºŒä¸ªæ–‡ä»¶ï¼ˆCCTVï¼‰
          if [ -s source2.m3u ]; then
            if grep -q "^#EXTM3U" source2.m3u; then
              tail -n +2 source2.m3u >> 2026IPTV.m3u
            else
              cat source2.m3u >> 2026IPTV.m3u
            fi
            SOURCE2_COUNT=$(grep -c "^#EXTINF" source2.m3u || echo "0")
          else
            echo "# æ³¨æ„ï¼šCCTVæºæ–‡ä»¶ä¸ºç©ºæˆ–ä¸‹è½½å¤±è´¥" >> 2026IPTV.m3u
            SOURCE2_COUNT=0
          fi
          
          TOTAL=$((SOURCE1_COUNT + SOURCE2_COUNT))
          echo "" >> 2026IPTV.m3u
          echo "# ğŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> 2026IPTV.m3u
          echo "# IPTVé¢‘é“æ•°: $SOURCE1_COUNT" >> 2026IPTV.m3u
          echo "# CCTVé¢‘é“æ•°: $SOURCE2_COUNT" >> 2026IPTV.m3u
          echo "# æ€»é¢‘é“æ•°: $TOTAL" >> 2026IPTV.m3u
          echo "# æ–‡ä»¶ç”Ÿæˆæ—¶é—´æˆ³: $(date +%s)" >> 2026IPTV.m3u
          
          FINAL_SIZE=$(wc -l < 2026IPTV.m3u | tr -d ' ')
          echo "ğŸ“ˆ åˆå¹¶å®Œæˆï¼šIPTVé¢‘é“ $SOURCE1_COUNT ä¸ªï¼ŒCCTVé¢‘é“ $SOURCE2_COUNT ä¸ªï¼Œå…± $TOTAL ä¸ªé¢‘é“"
          
      - name: 4. æäº¤æ–‡ä»¶
        run: |
          git config --global user.name 'IPTV Auto Updater'
          git config --global user.email 'actions@github.com'
          
          git add -f 2026IPTV.m3u
          
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          git commit -m "ğŸ”„ IPTVåˆ—è¡¨æ›´æ–° $TIMESTAMP" \
                     -m "æ›´æ–°äº $(date '+%Y-%m-%d %H:%M:%S') | é¢‘é“æ•°: $TOTAL" \
                     --allow-empty
          
          git push --force-with-lease origin HEAD
          echo "âœ… æ–‡ä»¶å·²æäº¤"
          
      - name: 5. éªŒè¯ä¿¡æ¯
        run: |
          echo "ğŸ“ ç”Ÿæˆæ–‡ä»¶ï¼š2026IPTV.m3u"
          echo "ğŸ“ æ–‡ä»¶å¤§å°ï¼š$(wc -l < 2026IPTV.m3u) è¡Œ"
          echo "â° ä¸‹æ¬¡è‡ªåŠ¨è¿è¡Œæ—¶é—´ï¼š8åˆ†é’Ÿåï¼ˆçº¦ $(date -d '+8 minutes' '+%H:%M:%S')ï¼‰"
          echo "ğŸ”— æ–‡ä»¶ç›´é“¾ï¼šhttps://raw.githubusercontent.com/${{ github.repository }}/main/2026IPTV.m3u"
