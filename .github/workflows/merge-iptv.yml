name: ğŸ•™ è‡ªåŠ¨åˆå¹¶IPTVåˆ—è¡¨ï¼ˆ10åˆ†é’Ÿç‰ˆï¼‰

on:
  schedule:
    # æ¯10åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆä¼˜åŒ–åçš„å¯é é—´éš”ï¼‰
    - cron: '*/10 * * * *'
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - '.github/workflows/merge-iptv.yml'
      - 'heartbeat.txt'  # å¿ƒè·³æ–‡ä»¶å˜åŒ–ä¹Ÿè§¦å‘

jobs:
  merge-iptv:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # é˜²æ­¢å¹¶å‘æ‰§è¡Œå†²çª
    concurrency:
      group: merge-iptv-${{ github.ref }}
      cancel-in-progress: false
    
    steps:
      - name: 1. æ£€æŸ¥è¿è¡Œæ¡ä»¶
        id: check
        run: |
          echo "ğŸ•™ å·¥ä½œæµå¼€å§‹æ‰§è¡Œï¼š$(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ“± è¿è¡Œå™¨ï¼š${{ runner.os }} ${{ runner.arch }}"
          
          # é¿å…è¿‡äºé¢‘ç¹çš„è§¦å‘
          if [[ "${{ github.event_name }}" == "push" && "${{ github.event.head_commit.message }}" == *"å¿ƒè·³æ›´æ–°"* ]]; then
            echo "ğŸ’“ å¿ƒè·³è§¦å‘ï¼Œç»§ç»­æ‰§è¡Œ..."
          fi
          
          echo "check_passed=true" >> $GITHUB_OUTPUT
          
      - name: 2. æ£€å‡ºä»£ç ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          clean: true
          # å¢åŠ é‡è¯•æ¬¡æ•°
          retry-on-error: true
          max-attempts: 3
          
      - name: 3. å¹¶è¡Œä¸‹è½½æºæ–‡ä»¶
        id: download
        timeout-minutes: 3
        run: |
          set -e
          echo "ğŸ“¥ å¼€å§‹å¹¶è¡Œä¸‹è½½æºæ–‡ä»¶..."
          
          # åˆ›å»ºä¸‹è½½å‡½æ•°
          download_with_retry() {
            local url=$1
            local output=$2
            local name=$3
            local max_retries=3
            local retry_delay=5
            
            for ((i=1; i<=max_retries; i++)); do
              echo "å°è¯• $i/$max_retries ä¸‹è½½ $name..."
              
              # ä½¿ç”¨curlä¸‹è½½ï¼Œè®¾ç½®è¶…æ—¶å’Œé‡è¯•
              if curl -s -L \
                --max-time 30 \
                --connect-timeout 20 \
                --retry 2 \
                --retry-delay 3 \
                -o "$output.tmp" \
                "$url" 2>/dev/null; then
                
                # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ
                if [ -s "$output.tmp" ] && { head -1 "$output.tmp" | grep -q "^#EXTM3U\|^http" || head -5 "$output.tmp" | grep -q "^#EXTINF"; }; then
                  mv "$output.tmp" "$output"
                  local lines=$(wc -l < "$output" | tr -d ' ')
                  local channels=$(grep -c "^#EXTINF" "$output" 2>/dev/null || echo "0")
                  echo "âœ… $name ä¸‹è½½æˆåŠŸ ($lines è¡Œ, $channels ä¸ªé¢‘é“)"
                  return 0
                else
                  echo "âš ï¸ $name å†…å®¹æ ¼å¼å¯èƒ½æ— æ•ˆ"
                fi
              fi
              
              if [ $i -lt $max_retries ]; then
                echo "ç­‰å¾… ${retry_delay}ç§’åé‡è¯•..."
                sleep $retry_delay
              fi
            done
            
            echo "âŒ $name ä¸‹è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"
            # åˆ›å»ºå ä½æ–‡ä»¶
            cat > "$output" << EOF
#EXTM3U
#EXTINF:-1,âš ï¸ $name æš‚æ—¶ä¸å¯ç”¨
# æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
# å°†åœ¨ä¸‹æ¬¡è‡ªåŠ¨æ›´æ–°æ—¶é‡è¯•
http://example.com
EOF
            return 1
          }
          
          # å¹¶è¡Œä¸‹è½½ï¼ˆä½¿ç”¨åå°è¿›ç¨‹ï¼‰
          download_with_retry "https://raw.githubusercontent.com/mytv-android/BRTV-Live-M3U8/main/iptv.m3u" "source1.m3u" "IPTVä¸»åˆ—è¡¨" &
          PID1=$!
          
          download_with_retry "https://raw.githubusercontent.com/liniani/BRTV-Live-M3U8/main/cctv.m3u" "source2.m3u" "CCTVåˆ—è¡¨" &
          PID2=$!
          
          # ç­‰å¾…æ‰€æœ‰ä¸‹è½½å®Œæˆ
          wait $PID1 && SOURCE1_OK=true || SOURCE1_OK=false
          wait $PID2 && SOURCE2_OK=true || SOURCE2_OK=false
          
          # è¾“å‡ºç»“æœ
          echo "source1_ok=$SOURCE1_OK" >> $GITHUB_OUTPUT
          echo "source2_ok=$SOURCE2_OK" >> $GITHUB_OUTPUT
          echo "download_time=$(date +%s)" >> $GITHUB_OUTPUT
          
      - name: 4. æ™ºèƒ½åˆå¹¶å¤„ç†
        id: merge
        run: |
          set -e
          echo "ğŸ”„ å¼€å§‹åˆå¹¶æ–‡ä»¶..."
          
          # è·å–å½“å‰æ—¶é—´
          CURRENT_TIME=$(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')
          NEXT_TIME=$(date -d '+10 minutes' '+%H:%M:%S')
          BEIJING_TIME=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')
          
          # ç»Ÿè®¡é¢‘é“æ•°é‡
          COUNT1=$(grep -c "^#EXTINF" source1.m3u 2>/dev/null || echo "0")
          COUNT2=$(grep -c "^#EXTINF" source2.m3u 2>/dev/null || echo "0")
          TOTAL=$((COUNT1 + COUNT2))
          
          # ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶
          {
            echo "#EXTM3U x-tvg-url=\"\""
            echo "# ############################################"
            echo "# ğŸ¬ 2026IPTV ç›´æ’­æº - è‡ªåŠ¨åˆå¹¶ç‰ˆ"
            echo "# ############################################"
            echo "#"
            echo "# ğŸ“… ç”Ÿæˆæ—¶é—´: $CURRENT_TIME (UTC)"
            echo "# ğŸ“… åŒ—äº¬æ—¶é—´: $BEIJING_TIME"
            echo "# ğŸ”„ æ›´æ–°é¢‘ç‡: æ¯10åˆ†é’Ÿè‡ªåŠ¨æ›´æ–°"
            echo "# â° ä¸‹æ¬¡æ›´æ–°: $NEXT_TIME (UTC)"
            echo "#"
            echo "# ğŸ“¡ æ•°æ®æ¥æº:"
            echo "#   â€¢ IPTVåˆ—è¡¨: https://github.com/mytv-android/BRTV-Live-M3U8"
            echo "#   â€¢ CCTVåˆ—è¡¨: https://github.com/liniani/BRTV-Live-M3U8"
            echo "#"
            echo "# ğŸ“Š é¢‘é“ç»Ÿè®¡:"
            echo "#   â€¢ IPTVé¢‘é“: $COUNT1 ä¸ª"
            echo "#   â€¢ CCTVé¢‘é“: $COUNT2 ä¸ª"
            echo "#   â€¢ æ€»é¢‘é“æ•°: $TOTAL ä¸ª"
            echo "#"
            echo "# ğŸ”— æ°¸ä¹…é“¾æ¥:"
            echo "#   https://raw.githubusercontent.com/${{ github.repository }}/main/2026IPTV.m3u"
            echo "#"
            echo "# ğŸ’¡ ä½¿ç”¨è¯´æ˜:"
            echo "#   1. å°†æ­¤é“¾æ¥æ·»åŠ åˆ°æ”¯æŒM3Uçš„æ’­æ”¾å™¨"
            echo "#   2. æ”¯æŒ: VLC, Kodi, TiviMate, IPTV Smartersç­‰"
            echo "#   3. æ–‡ä»¶æ¯10åˆ†é’Ÿè‡ªåŠ¨æ›´æ–°"
            echo "#"
            echo "# âš ï¸ å…è´£å£°æ˜:"
            echo "#   æœ¬åˆ—è¡¨ä»…æ”¶é›†å…¬å¼€ç›´æ’­æºï¼Œç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰"
            echo "#   è¯·äº24å°æ—¶å†…åˆ é™¤ï¼Œä»…é™ä¸ªäººæµ‹è¯•ä½¿ç”¨"
            echo "# ############################################"
            echo ""
            echo ""
            
            # åˆå¹¶ç¬¬ä¸€ä¸ªæº
            echo "# ========================="
            echo "# ğŸ“º IPTV ç›´æ’­é¢‘é“ ($COUNT1 ä¸ª)"
            echo "# ========================="
            if [ "$COUNT1" -gt 0 ] && [ "${{ steps.download.outputs.source1_ok }}" = "true" ]; then
              # è¿‡æ»¤æ‰é‡å¤çš„M3Uå¤´
              grep -v "^\s*$" source1.m3u | grep -v "^#EXTM3U" | sed '/^#/! s/^/\n/'
            else
              echo "#EXTINF:-1,é¢‘é“åˆ—è¡¨æš‚æ—¶ä¸å¯ç”¨"
              echo "# è¯·ç­‰å¾…ä¸‹æ¬¡è‡ªåŠ¨æ›´æ–° (çº¦10åˆ†é’Ÿå)"
              echo "http://example.com"
            fi
            
            echo ""
            echo ""
            
            # åˆå¹¶ç¬¬äºŒä¸ªæº
            echo "# ========================="
            echo "# ğŸ  ä¸­å¤®ç”µè§†å°é¢‘é“ ($COUNT2 ä¸ª)"
            echo "# ========================="
            if [ "$COUNT2" -gt 0 ] && [ "${{ steps.download.outputs.source2_ok }}" = "true" ]; then
              grep -v "^\s*$" source2.m3u | grep -v "^#EXTM3U" | sed '/^#/! s/^/\n/'
            else
              echo "#EXTINF:-1,é¢‘é“åˆ—è¡¨æš‚æ—¶ä¸å¯ç”¨"
              echo "# è¯·ç­‰å¾…ä¸‹æ¬¡è‡ªåŠ¨æ›´æ–° (çº¦10åˆ†é’Ÿå)"
              echo "http://example.com"
            fi
            
            echo ""
            echo ""
            echo "# ############################################"
            echo "# ğŸ æ–‡ä»¶ç»“æŸ"
            echo "# æœ€åæ›´æ–°æ—¶é—´æˆ³: $(date +%s)"
            echo "# MD5æ ¡éªŒç : $(echo "$CURRENT_TIME$TOTAL" | md5sum | cut -d' ' -f1)"
            echo "# æ€»è¡Œæ•°: $(cat source1.m3u source2.m3u 2>/dev/null | wc -l)"
            echo "# ############################################"
            
          } > "2026IPTV.m3u"
          
          # éªŒè¯æ–‡ä»¶
          if [ -s "2026IPTV.m3u" ] && grep -q "^#EXTINF" "2026IPTV.m3u" 2>/dev/null; then
            FINAL_COUNT=$(grep -c "^#EXTINF" "2026IPTV.m3u")
            echo "âœ… åˆå¹¶å®Œæˆï¼æœ€ç»ˆé¢‘é“æ•°: $FINAL_COUNT"
            echo "merge_success=true" >> $GITHUB_OUTPUT
            echo "final_channels=$FINAL_COUNT" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ åˆå¹¶æ–‡ä»¶å¯èƒ½ä¸ºç©ºï¼Œå°è¯•ä½¿ç”¨ç¼“å­˜"
            if [ -f "2026IPTV_backup.m3u" ]; then
              cp "2026IPTV_backup.m3u" "2026IPTV.m3u"
              echo "ğŸ”„ ä½¿ç”¨å¤‡ä»½æ–‡ä»¶"
              echo "merge_success=false" >> $GITHUB_OUTPUT
            else
              echo "âŒ æ— å¯ç”¨å¤‡ä»½ï¼Œåˆ›å»ºç©ºæ–‡ä»¶"
              echo "merge_success=false" >> $GITHUB_OUTPUT
            fi
          fi
          
          # åˆ›å»ºå¤‡ä»½
          cp "2026IPTV.m3u" "2026IPTV_backup.m3u"
          
      - name: 5. æ™ºèƒ½Gitæäº¤
        if: steps.merge.outputs.merge_success == 'true'
        env:
          GIT_STRATEGY: recursive
        run: |
          echo "ğŸ’¾ å‡†å¤‡æäº¤æ›´æ”¹..."
          
          # é…ç½®Git
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git config --global pull.rebase true
          
          # æ‹‰å–æœ€æ–°ä»£ç ï¼ˆé¿å…å†²çªï¼‰
          echo "ğŸ“¡ åŒæ­¥è¿œç¨‹ä»“åº“..."
          git pull origin main --no-edit --strategy=recursive -Xtheirs || \
          git pull origin main --no-edit --allow-unrelated-histories || true
          
          # æ·»åŠ æ–‡ä»¶
          git add -f 2026IPTV.m3u 2026IPTV_backup.m3u
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --cached --quiet; then
            echo "ğŸ“„ æ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
            echo "git_updated=false" >> $GITHUB_OUTPUT
          else
            # ç”Ÿæˆæäº¤ä¿¡æ¯
            CHANNELS="${{ steps.merge.outputs.final_channels }}"
            COMMIT_MSG="ğŸ”„ IPTVåˆ—è¡¨æ›´æ–° $(date '+%m-%d %H:%M')"
            COMMIT_DESC="é¢‘é“æ€»æ•°: $CHANNELS | è‡ªåŠ¨æ›´æ–° | æ¯10åˆ†é’Ÿ"
            
            # æäº¤
            git commit -m "$COMMIT_MSG" \
                       -m "$COMMIT_DESC" \
                       -m "æ¥æº: mytv-android/BRTV-Live-M3U8 + liniani/BRTV-Live-M3U8"
            
            # å®‰å…¨æ¨é€ï¼ˆå¸¦é‡è¯•ï¼‰
            for i in {1..3}; do
              echo "ğŸš€ æ¨é€å°è¯• #$i..."
              if git push origin main; then
                echo "âœ… æ¨é€æˆåŠŸ"
                echo "git_updated=true" >> $GITHUB_OUTPUT
                break
              elif [ $i -eq 3 ]; then
                echo "âŒ æ¨é€å¤±è´¥ï¼Œå·²é‡è¯•3æ¬¡"
                echo "git_updated=false" >> $GITHUB_OUTPUT
              else
                echo "â¸ï¸ æ¨é€å¤±è´¥ï¼Œ10ç§’åé‡è¯•..."
                sleep 10
                git pull origin main --rebase
              fi
            done
          fi
          
      - name: 6. ç”ŸæˆçŠ¶æ€æŠ¥å‘Š
        if: always()
        run: |
          echo "ğŸ“‹ ================================"
          echo "ğŸ“‹ å·¥ä½œæµæ‰§è¡ŒæŠ¥å‘Š"
          echo "ğŸ“‹ ================================"
          echo ""
          
          # æ–‡ä»¶ä¿¡æ¯
          if [ -f "2026IPTV.m3u" ]; then
            FILE_SIZE=$(wc -l < "2026IPTV.m3u")
            FILE_CHANNELS=$(grep -c "^#EXTINF" "2026IPTV.m3u" 2>/dev/null || echo "0")
            FILE_AGE=$(( $(date +%s) - $(stat -c %Y "2026IPTV.m3u" 2>/dev/null || echo 0) ))
            
            echo "ğŸ“ æœ€ç»ˆæ–‡ä»¶: 2026IPTV.m3u"
            echo "ğŸ“ æ–‡ä»¶è¡Œæ•°: $FILE_SIZE"
            echo "ğŸ“º é¢‘é“æ•°é‡: $FILE_CHANNELS"
            echo "â±ï¸  ç”Ÿæˆæ—¶é—´: ${FILE_AGE}ç§’å‰"
            echo ""
            echo "ğŸ“„ æ–‡ä»¶é¢„è§ˆï¼ˆå‰3ä¸ªé¢‘é“ï¼‰:"
            echo "------------------------"
            grep -A1 "^#EXTINF" "2026IPTV.m3u" | head -6
            echo ""
          else
            echo "âŒ é”™è¯¯ï¼šæœ€ç»ˆæ–‡ä»¶æœªç”Ÿæˆ"
          fi
          
          # æ—¶é—´ä¿¡æ¯
          echo "â° æ—¶é—´ä¿¡æ¯:"
          echo "  UTCæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "  åŒ—äº¬æ—¶é—´: $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')"
          echo "  ä¸‹æ¬¡è¿è¡Œ: $(date -d '+10 minutes' '+%H:%M:%S') (UTC)"
          echo ""
          
          # è®¿é—®é“¾æ¥
          echo "ğŸ”— è®¿é—®é“¾æ¥:"
          echo "  ç›´æ¥è®¿é—®: https://raw.githubusercontent.com/${{ github.repository }}/main/2026IPTV.m3u"
          echo "  å¸¦ç¼“å­˜åˆ·æ–°: https://raw.githubusercontent.com/${{ github.repository }}/main/2026IPTV.m3u?t=$(date +%s)"
          echo ""
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f source1.m3u source2.m3u *.tmp
          echo "ğŸ§¹ ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"
          
      - name: 7. å¤±è´¥é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        if: failure()
        run: |
          echo "âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥ï¼"
          echo ""
          echo "ğŸ” å¯èƒ½åŸå› :"
          echo "  â€¢ ğŸŒ ç½‘ç»œè¿æ¥é—®é¢˜ - æºç«™æ— æ³•è®¿é—®"
          echo "  â€¢ â±ï¸  è¶…æ—¶é—®é¢˜ - ä¸‹è½½æ—¶é—´è¿‡é•¿"
          echo "  â€¢ ğŸ” æƒé™é—®é¢˜ - Gitæ¨é€å¤±è´¥"
          echo "  â€¢ ğŸ’¾ ç£ç›˜ç©ºé—´ä¸è¶³"
          echo ""
          echo "ğŸ’¡ è§£å†³æ–¹æ¡ˆ:"
          echo "  1. æ£€æŸ¥æºURLæ˜¯å¦å¯è®¿é—®"
          echo "  2. æ‰‹åŠ¨è¿è¡Œå·¥ä½œæµæµ‹è¯•"
          echo "  3. ç­‰å¾…ä¸‹ä¸€æ¬¡è‡ªåŠ¨é‡è¯•ï¼ˆ10åˆ†é’Ÿåï¼‰"
          echo "  4. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—å®šä½é—®é¢˜"
          echo ""
          echo "ğŸ“ è°ƒè¯•ä¿¡æ¯:"
          echo "  å·¥ä½œæµ: ${{ github.workflow }}"
          echo "  è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
          echo "  æäº¤: ${{ github.sha }}"
