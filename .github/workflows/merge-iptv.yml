name: ğŸ“º IPTV Auto Merge (10 Minutes)

on:
  schedule:
    # ä½¿ç”¨ä¸¤ä¸ªcronè¡¨è¾¾å¼æé«˜å¯é æ€§
    - cron: '*/10 * * * *'        # æ¯10åˆ†é’Ÿ
    - cron: '2-59/10 * * * *'     # æ¯10åˆ†é’Ÿï¼ˆåç§»2åˆ†é’Ÿï¼‰
  workflow_dispatch:               # æ‰‹åŠ¨è§¦å‘
  push:                            # ä»£ç æ¨é€è§¦å‘
    branches: [ main ]
    paths:
      - '.github/workflows/merge-iptv.yml'
      - 'keep-alive.txt'
  # æ·»åŠ repository_dispatchç”¨äºå¤–éƒ¨è§¦å‘
  repository_dispatch:
    types: ['run-merge']

# æ¯åˆ†é’Ÿæ£€æµ‹çš„ç®€åŒ–ç‰ˆæœ¬ï¼ˆæ›´å¯é ï¼‰
# å¦‚æœä¸Šè¿°ä¸å·¥ä½œï¼Œå°è¯•è¿™ä¸ªï¼š
# on:
#   schedule:
#     - cron: '* * * * *'           # æ¯åˆ†é’Ÿ
#   workflow_dispatch:

jobs:
  merge:
    runs-on: ubuntu-latest
    timeout-minutes: 4
    
    # é˜²æ­¢å¹¶å‘å†²çª
    concurrency:
      group: merge-${{ github.sha }}
      cancel-in-progress: false
    
    steps:
    - name: ğŸ•’ æ£€æŸ¥æ˜¯å¦åº”è¯¥è¿è¡Œï¼ˆ10åˆ†é’Ÿé—´éš”ï¼‰
      id: check-interval
      run: |
        # è®¾ç½®æœ€å°é—´éš”ä¸º9åˆ†é’Ÿ
        MIN_INTERVAL=540  # 9åˆ†é’Ÿï¼ˆç§’ï¼‰
        LAST_RUN_FILE=".last_run"
        
        if [ -f "$LAST_RUN_FILE" ]; then
          LAST_RUN=$(cat "$LAST_RUN_FILE")
          NOW=$(date +%s)
          ELAPSED=$((NOW - LAST_RUN))
          
          if [ $ELAPSED -lt $MIN_INTERVAL ]; then
            echo "â¸ï¸ è·ç¦»ä¸Šæ¬¡è¿è¡Œä»… ${ELAPSED}ç§’ï¼Œè·³è¿‡æœ¬æ¬¡æ‰§è¡Œï¼ˆéœ€è¦è‡³å°‘ ${MIN_INTERVAL}ç§’ï¼‰"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi
        fi
        
        # è®°å½•æœ¬æ¬¡è¿è¡Œæ—¶é—´
        date +%s > "$LAST_RUN_FILE"
        echo "âœ… å¯ä»¥æ‰§è¡Œï¼Œè·ç¦»ä¸Šæ¬¡è¿è¡Œ: ${ELAPSED:-9999}ç§’"
        echo "should_run=true" >> $GITHUB_OUTPUT
        
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      if: steps.check-interval.outputs.should_run == 'true'
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: ğŸ”§ è®¾ç½®ç¯å¢ƒ
      if: steps.check-interval.outputs.should_run == 'true'
      run: |
        echo "ğŸ¬ å¼€å§‹æ‰§è¡ŒIPTVåˆå¹¶"
        echo "æ—¶é—´: $(date)"
        echo "äº‹ä»¶: ${{ github.event_name }}"
        echo "æäº¤: ${{ github.sha }}"
        
    - name: ğŸ“¥ ä¸‹è½½IPTVåˆ—è¡¨
      if: steps.check-interval.outputs.should_run == 'true'
      id: download
      run: |
        set -e
        
        # ä¸‹è½½ç¬¬ä¸€ä¸ªæº
        echo "ä¸‹è½½ IPTVåˆ—è¡¨..."
        if curl -s -L --max-time 30 --retry 2 \
          "https://raw.githubusercontent.com/mytv-android/BRTV-Live-M3U8/main/iptv.m3u" \
          -o source1.m3u; then
          
          if [ -s source1.m3u ] && grep -q "^#EXTINF" source1.m3u; then
            COUNT1=$(grep -c "^#EXTINF" source1.m3u)
            echo "âœ… IPTVåˆ—è¡¨ä¸‹è½½æˆåŠŸ: $COUNT1 ä¸ªé¢‘é“"
            echo "source1_count=$COUNT1" >> $GITHUB_OUTPUT
            SOURCE1_OK=true
          else
            echo "âš ï¸ IPTVåˆ—è¡¨å†…å®¹æ— æ•ˆ"
            SOURCE1_OK=false
          fi
        else
          echo "âŒ IPTVåˆ—è¡¨ä¸‹è½½å¤±è´¥"
          SOURCE1_OK=false
        fi
        
        # ä¸‹è½½ç¬¬äºŒä¸ªæº
        echo "ä¸‹è½½ CCTVåˆ—è¡¨..."
        if curl -s -L --max-time 30 --retry 2 \
          "https://raw.githubusercontent.com/liniani/BRTV-Live-M3U8/main/cctv.m3u" \
          -o source2.m3u; then
          
          if [ -s source2.m3u ] && grep -q "^#EXTINF" source2.m3u; then
            COUNT2=$(grep -c "^#EXTINF" source2.m3u)
            echo "âœ… CCTVåˆ—è¡¨ä¸‹è½½æˆåŠŸ: $COUNT2 ä¸ªé¢‘é“"
            echo "source2_count=$COUNT2" >> $GITHUB_OUTPUT
            SOURCE2_OK=true
          else
            echo "âš ï¸ CCTVåˆ—è¡¨å†…å®¹æ— æ•ˆ"
            SOURCE2_OK=false
          fi
        else
          echo "âŒ CCTVåˆ—è¡¨ä¸‹è½½å¤±è´¥"
          SOURCE2_OK=false
        fi
        
        echo "source1_ok=$SOURCE1_OK" >> $GITHUB_OUTPUT
        echo "source2_ok=$SOURCE2_OK" >> $GITHUB_OUTPUT
        
    - name: ğŸ§© åˆå¹¶æ–‡ä»¶
      if: steps.check-interval.outputs.should_run == 'true'
      run: |
        # åˆ›å»ºåˆå¹¶æ–‡ä»¶
        cat > 2026IPTV.m3u << 'EOF'
#EXTM3U
# ########################################
# ğŸ¬ 2026IPTV - è‡ªåŠ¨åˆå¹¶ç›´æ’­æº
# ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
# æ›´æ–°é¢‘ç‡: æ¯10åˆ†é’Ÿ
# æ•°æ®æº: mytv-android/BRTV + liniani/BRTV
# ########################################

EOF
        
        # æ·»åŠ IPTVæº
        if [ "${{ steps.download.outputs.source1_ok }}" = "true" ]; then
          echo "# ğŸ¯ IPTVç›´æ’­æº" >> 2026IPTV.m3u
          cat source1.m3u >> 2026IPTV.m3u
          echo "" >> 2026IPTV.m3u
        fi
        
        # æ·»åŠ CCTVæº
        if [ "${{ steps.download.outputs.source2_ok }}" = "true" ]; then
          echo "# ğŸ“º CCTVé¢‘é“" >> 2026IPTV.m3u
          cat source2.m3u >> 2026IPTV.m3u
          echo "" >> 2026IPTV.m3u
        fi
        
        # æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
        cat >> 2026IPTV.m3u << EOF
# ########################################
# ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
# æ€»é¢‘é“æ•°: $(({{ steps.download.outputs.source1_count || 0 }} + {{ steps.download.outputs.source2_count || 0 }}))
# æ›´æ–°æ—¶é—´æˆ³: $(date +%s)
# ä¸‹æ¬¡æ›´æ–°: $(date -d '+10 minutes' '+%H:%M')
# æ°¸ä¹…é“¾æ¥: https://raw.githubusercontent.com/${{ github.repository }}/main/2026IPTV.m3u
# ########################################
EOF
        
        echo "âœ… æ–‡ä»¶åˆå¹¶å®Œæˆ"
        LINES=$(wc -l < 2026IPTV.m3u)
        CHANNELS=$(grep -c "^#EXTINF" 2026IPTV.m3u 2>/dev/null || echo 0)
        echo "æ–‡ä»¶è¡Œæ•°: $LINES"
        echo "é¢‘é“æ•°é‡: $CHANNELS"
        
    - name: ğŸ“¤ æäº¤æ›´æ–°
      if: steps.check-interval.outputs.should_run == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # é…ç½®Git
        git config --global user.name "github-actions"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        git add 2026IPTV.m3u
        
        if git diff --cached --quiet; then
          echo "ğŸ“„ æ²¡æœ‰æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸ’¾ æäº¤æ›´æ”¹..."
          
          # æäº¤
          git commit -m "ğŸ”„ IPTVåˆ—è¡¨æ›´æ–° $(date '+%m-%d %H:%M')" \
                     -m "è‡ªåŠ¨åˆå¹¶ | æ¯10åˆ†é’Ÿæ›´æ–°" \
                     --allow-empty
          
          # æ¨é€
          git pull --rebase origin main
          if git push origin main; then
            echo "âœ… æ¨é€æˆåŠŸ"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ¨é€å¤±è´¥"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
        fi
        
    - name: ğŸ“Š ç”ŸæˆæŠ¥å‘Š
      if: always()
      run: |
        echo "========================================"
        echo "           ğŸ¬ IPTVåˆå¹¶æŠ¥å‘Š"
        echo "========================================"
        echo ""
        echo "ğŸƒ æ‰§è¡ŒçŠ¶æ€: ${{ job.status }}"
        echo "â° è¿è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo ""
        
        if [ -f "2026IPTV.m3u" ]; then
          echo "ğŸ“ æ–‡ä»¶ä¿¡æ¯:"
          echo "  æ–‡ä»¶å: 2026IPTV.m3u"
          echo "  å¤§å°: $(wc -l < 2026IPTV.m3u) è¡Œ"
          echo "  é¢‘é“: $(grep -c "^#EXTINF" 2026IPTV.m3u 2>/dev/null || echo 0) ä¸ª"
          echo ""
          echo "ğŸ”— è®¿é—®é“¾æ¥:"
          echo "  https://raw.githubusercontent.com/${{ github.repository }}/main/2026IPTV.m3u"
          echo ""
        fi
        
        echo "ğŸ”„ ä¸‹æ¬¡è¿è¡Œ: $(date -d '+10 minutes' '+%H:%M:%S')"
        echo ""
        echo "ğŸ’¡ å¦‚æœå®šæ—¶ä»»åŠ¡ä¸å·¥ä½œ:"
        echo "  1. æ‰‹åŠ¨è¿è¡Œ: Actions â†’ Workflows â†’ Run workflow"
        echo "  2. ç¡®ä¿ä»“åº“æ˜¯å…¬å¼€çš„"
        echo "  3. æŸ¥çœ‹Actionæ—¥å¿—å¯»æ‰¾é”™è¯¯"
        
    - name: ğŸ§¹ æ¸…ç†
      if: always()
      run: |
        rm -f source1.m3u source2.m3u .last_run
        echo "ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"
