name: ğŸ•™ è‡ªåŠ¨åˆå¹¶IPTVåˆ—è¡¨ (æ¯10åˆ†é’Ÿ)

on:
  # æ ¸å¿ƒè§¦å‘å™¨ï¼šæ¯10åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ (UTCæ—¶é—´)
  schedule:
    - cron: '*/10 * * * *'
  # å¤‡ç”¨è§¦å‘å™¨ï¼šæ”¯æŒæ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/merge-iptv.yml'

# ğŸ”‘ æœ€å…³é”®çš„ä¸€è¡Œï¼šæˆäºˆå·¥ä½œæµå†™å…¥æƒé™ï¼Œè¿™æ˜¯è‡ªåŠ¨è¿è¡Œçš„åŸºç¡€
permissions:
  contents: write

jobs:
  merge-iptv:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: 1. åˆå§‹åŒ–ç¯å¢ƒ
        run: |
          echo "ğŸ”„ å·¥ä½œæµå¼€å§‹æ‰§è¡Œï¼š$(date '+%Y-%m-%d %H:%M:%S')"
          echo "è§¦å‘æ–¹å¼ï¼š${{ github.event_name }}"

      - name: 2. æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          clean: true

      - name: 3. ä¸‹è½½æºæ–‡ä»¶
        id: download
        run: |
          set -e
          echo "ğŸ“¥ å¼€å§‹ä¸‹è½½æºæ–‡ä»¶..."

          download_file() {
            local url=$1
            local output=$2
            local name=$3
            echo "æ­£åœ¨ä¸‹è½½ $name..."
            if curl -s -L --max-time 30 --retry 2 -o "$output" "$url"; then
              if [ -s "$output" ]; then
                lines=$(wc -l < "$output")
                echo "âœ… $name ä¸‹è½½æˆåŠŸ ($lines è¡Œ)"
                return 0
              fi
            fi
            echo "âš ï¸ $name ä¸‹è½½å¤±è´¥æˆ–å†…å®¹ä¸ºç©ºï¼Œåˆ›å»ºå ä½æ–‡ä»¶"
            echo "# $name æºæš‚æ—¶ä¸å¯ç”¨" > "$output"
            return 1
          }

          download_file "https://raw.githubusercontent.com/mytv-android/BRTV-Live-M3U8/refs/heads/main/iptv.m3u" "source1.m3u" "IPTVåˆ—è¡¨"
          download_file "https://raw.githubusercontent.com/liniani/BRTV-Live-M3U8/refs/heads/main/cctv.m3u" "source2.m3u" "CCTVåˆ—è¡¨"

      - name: 4. åˆå¹¶æ–‡ä»¶
        id: merge
        run: |
          set -e
          CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          
          SOURCE1_COUNT=$(grep -c "^#EXTINF" source1.m3u 2>/dev/null || echo "0")
          SOURCE2_COUNT=$(grep -c "^#EXTINF" source2.m3u 2>/dev/null || echo "0")
          TOTAL=$((SOURCE1_COUNT + SOURCE2_COUNT))

          {
            echo "#EXTM3U"
            echo "# ç”Ÿæˆæ—¶é—´ï¼š$CURRENT_TIME"
            echo "# æ›´æ–°é¢‘ç‡ï¼šæ¯10åˆ†é’Ÿ"
            echo "# é¢‘é“ç»Ÿè®¡ï¼šIPTV($SOURCE1_COUNT) + CCTV($SOURCE2_COUNT) = $TOTAL"
            echo ""
            echo "# ğŸ“º IPTV é¢‘é“"
            grep -v "^#EXTM3U" source1.m3u 2>/dev/null || cat source1.m3u
            echo ""
            echo "# ğŸ  CCTV é¢‘é“"
            grep -v "^#EXTM3U" source2.m3u 2>/dev/null || cat source2.m3u
          } > 2026IPTV.m3u

          if [ -s "2026IPTV.m3u" ]; then
            echo "âœ… åˆå¹¶æ–‡ä»¶åˆ›å»ºæˆåŠŸï¼Œå…± $TOTAL ä¸ªé¢‘é“"
            echo "total_channels=$TOTAL" >> $GITHUB_OUTPUT
            echo "merge_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ åˆå¹¶å¤±è´¥ï¼Œæ–‡ä»¶ä¸ºç©º"
            echo "merge_success=false" >> $GITHUB_OUTPUT
          fi

      - name: 5. æäº¤ä¸æ¨é€
        if: steps.merge.outputs.merge_success == 'true'
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          git pull origin main --rebase --autostash 2>/dev/null || true
          git add 2026IPTV.m3u
          
          if ! git diff --cached --quiet; then
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°IPTVåˆ—è¡¨ [$(date '+%H:%M')]" \
                       -m "é¢‘é“æ•°ï¼š${{ steps.merge.outputs.total_channels }}"
            # å®‰å…¨æ¨é€
            for i in 1 2 3; do
              if git push origin main; then
                echo "âœ… æ¨é€æˆåŠŸ (å°è¯• $i æ¬¡)"
                break
              else
                echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œç­‰å¾…åé‡è¯•..."
                sleep 5
                git pull origin main --rebase
              fi
            done
          else
            echo "ğŸ“„ æ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi

      - name: 6. æœ€ç»ˆæŠ¥å‘Š
        run: |
          echo "=== æ‰§è¡Œå®Œæˆ ==="
          echo "çŠ¶æ€ï¼š${{ job.status }}"
          if [ -f "2026IPTV.m3u" ]; then
            echo "æ–‡ä»¶ï¼š2026IPTV.m3u"
            echo "é“¾æ¥ï¼šhttps://raw.githubusercontent.com/${{ github.repository }}/main/2026IPTV.m3u"
          fi
          echo "================"
          rm -f source1.m3u source2.m3u
